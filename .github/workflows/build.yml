name: Build and release

on:
  push:
    tags:
      - 'v*'
    branches:
      - master

env:
  GO_VERSION: '1.25.3'
  NODE_VERSION: '24.10.0'
  DIST_FOLDER: dist
  REGISTRY: ghcr.io
  DEV_VERSION_NAME: v0.0.0-d.0
  DEV_VERSION_CHECK: d.
  BUILD_CHANNEL: release

concurrency:
  group: build_and_release
  cancel-in-progress: true

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      GO111MODULE: on
      GOPROXY: https://proxy.golang.org,direct
      VERSION: ${{ github.ref_name }}
      NPM_CACHE_DIR: ''
      PREV_VERSION: master
      CHANGE_LOGS: "* ${{ github.event.head_commit.message }}"
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Normalize version for master branch
        if: ${{ github.ref_name == 'master' }}
        run: echo "VERSION=${{ env.DEV_VERSION_NAME }}" >> "$GITHUB_ENV"
      - name: Get npm cache directory
        id: npm-cache
        run: echo "NPM_CACHE_DIR=$(npm config get cache)" >> "$GITHUB_ENV"
      - name: Set up npm cache
        if: ${{ env.NPM_CACHE_DIR != '' }}
        uses: actions/cache@v4
        with:
          path: ${{ env.NPM_CACHE_DIR }}
          key: ${{ format('{0}-node-{1}', runner.os, hashFiles('client/package-lock.json')) }}
          restore-keys: ${{ runner.os }}-node-
      - name: Set previous version env
        if: ${{ env.VERSION != env.DEV_VERSION_NAME }}
        run: |
          PREV_VERSION=$(git describe --tags --abbrev=0 "${{ env.VERSION }}^")
          if [[ "$PREV_VERSION" == v* ]]; then
            echo "PREV_VERSION=${PREV_VERSION}" >> "$GITHUB_ENV"
          else
            echo "Cannot find previous version. Using ${{ env.PREV_VERSION }} as fallback."
          fi
      - name: Set change logs env
        if: ${{ env.VERSION != env.DEV_VERSION_NAME }}
        run: |
          CHANGE_LOGS=$(git log --no-merges --pretty='format:* %h: %s' "${{ env.VERSION }}...${{ env.PREV_VERSION }}")
          if [ -n "$CHANGE_LOGS" ]; then
            {
              echo 'CHANGE_LOGS<<EOF'
              echo "$CHANGE_LOGS"
              echo EOF
            } >> "$GITHUB_ENV"
          else
            echo "Fallback to latest commit message for change log"
          fi

      # Release build block
      - name: Set up QEMU
        if: ${{ !contains(env.VERSION, env.DEV_VERSION_CHECK) }}
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        if: ${{ !contains(env.VERSION, env.DEV_VERSION_CHECK) }}
        uses: docker/setup-buildx-action@v3
      - name: Log in to the Container registry
        if: ${{ !contains(env.VERSION, env.DEV_VERSION_CHECK) }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set beta build channel
        if: ${{ contains(env.VERSION, 'b.') }}
        run: echo "BUILD_CHANNEL=beta" >> "$GITHUB_ENV"
      - name: Run release build
        if: ${{ !contains(env.VERSION, env.DEV_VERSION_CHECK) }}
        run: |
          make SIGN=0 VERBOSE=1 CHANNEL="${{ env.BUILD_CHANNEL }}" DOCKER_IMAGE_NAME="${{ env.REGISTRY }}/quydang04/adguardhome" \
            DOCKER_OUTPUT="type=image,name=${{ env.REGISTRY }}/quydang04/adguardhome,push=true" VERSION="${{ env.VERSION }}" \
            build-release build-docker
          rm -rf "${{ env.DIST_FOLDER }}/AdGuardHome_frontend.tar.gz"
      - name: Create release
        if: ${{ !contains(env.VERSION, env.DEV_VERSION_CHECK) }}
        uses: ncipollo/release-action@v1
        with:
          prerelease: ${{ env.BUILD_CHANNEL != 'release' }}
          artifacts: "${{ env.DIST_FOLDER }}/*.tar.gz,${{ env.DIST_FOLDER }}/*.zip,${{ env.DIST_FOLDER }}/checksums.txt"
          body: |
            ## ${{ env.BUILD_CHANNEL == 'release' && 'Stable' || 'Beta' }} release from quydang04/AdGuardHome

            ### Build information:
            * GO version: **${{ env.GO_VERSION }}**
            * Node version: **${{ env.NODE_VERSION }}**
            * Release version: **${{ env.VERSION }}**

            ### What's changed:
            ${{ env.CHANGE_LOGS }}

            **Full Changelog**: https://github.com/quydang04/AdGuardHome/compare/${{ env.PREV_VERSION }}...${{ env.VERSION }}
            **Notice**: This build is maintained in the quydang04 fork and may diverge from upstream AdGuardHome.


      # Development build block
      - name: Run development build
        if: ${{ contains(env.VERSION, env.DEV_VERSION_CHECK) }}
        run: |
          make SIGN=0 VERBOSE=1 VERSION="${{ env.VERSION }}" build-release
          rm -rf "${{ env.DIST_FOLDER }}/AdGuardHome_frontend.tar.gz"
      - name: Create development release
        if: ${{ env.VERSION != env.DEV_VERSION_NAME && contains(env.VERSION, env.DEV_VERSION_CHECK) }}
        uses: ncipollo/release-action@v1
        with:
          prerelease: true
          artifacts: "${{ env.DIST_FOLDER }}/*.tar.gz,${{ env.DIST_FOLDER }}/*.zip,${{ env.DIST_FOLDER }}/checksums.txt"
          body: |
            ## Development release from quydang04/AdGuardHome

            ### Build information:
            * GO version: **${{ env.GO_VERSION }}**
            * Node version: **${{ env.NODE_VERSION }}**
            * Release version: **${{ env.VERSION }}**

            ### What's changed:
            ${{ env.CHANGE_LOGS }}

            **Full Changelog**: https://github.com/quydang04/AdGuardHome/compare/${{ env.PREV_VERSION }}...${{ env.VERSION }}
            **Notice**: This development build is provided as-is and may contain unfinished changes.